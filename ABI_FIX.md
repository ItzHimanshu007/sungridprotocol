# ABI Error Fix - Applied ✅

## Problem
Users encountered the error: **"abi.filter is not a function"** when trying to create listings.

## Root Cause
The ABI JSON files generated by Foundry's `forge` tool are wrapped in an object format:
```json
{
  "abi": [ /* actual ABI array */ ],
  "bytecode": { /* ... */ },
  "methodIdentifiers": { /* ... */ }
}
```

But viem/wagmi expects just the ABI array:
```json
[ /* ABI items */ ]
```

## Solution Applied

**File**: `/apps/web/lib/contracts.ts`

**Changes**:
```typescript
// BEFORE (broken)
import EnergyTokenABI from './abi/EnergyToken.json';
export const ABIS = {
    EnergyToken: EnergyTokenABI,  // This is {abi: [...]}
};

// AFTER (fixed)
import EnergyTokenABIData from './abi/EnergyToken.json';

const extractABI = (abiData: any) => {
    return abiData.abi || abiData;  // Extract array
};

export const ABIS = {
    EnergyToken: extractABI(EnergyTokenABIData),  // Now this is [...]
};
```

## How to Test

1. **Refresh your browser** at `http://localhost:3000`
2. **Navigate to Create Listing** page
3. **Fill out the form**:
   - Energy Amount: `50` kWh
   - Price per kWh: `0.0001` ETH
   - Location: `Test Zone`
   - Description: `Test listing`
4. **Click "Prepare Listing"**

The error should be gone and the transaction should process correctly through all 4 steps:
1. ✅ Upload to IPFS
2. ✅ Mint Energy Token
3. ✅ Approve Marketplace
4. ✅ Create Listing

## Why This Works

The `extractABI()` function handles both formats:
- If the import is already an array → returns it as-is
- If the import is wrapped `{abi: [...]}` → extracts the `.abi` property

This makes it compatible with:
- Hardhat ABIs (plain arrays)
- Foundry ABIs (wrapped objects)

## Verification Checklist

- [x] Fixed `/apps/web/lib/contracts.ts`
- [x] Added `extractABI()` helper function
- [x] Applied to all three ABIs (EnergyToken, Marketplace, PricingOracle)
- [x] Hot reload should have picked up changes
- [ ] Test creating a listing (user action required)

## If Error Persists

Try these steps:

1. **Hard Refresh Browser**: `Cmd + Shift + R` (Mac) or `Ctrl + Shift + R` (Windows)

2. **Restart Next.js Dev Server**:
   ```bash
   # Stop current server (Ctrl+C)
   cd apps/web
   npm run dev
   ```

3. **Clear Next.js Cache**:
   ```bash
   cd apps/web
   rm -rf .next
   npm run dev
   ```

4. **Check Browser Console** for any new errors

---

**Status**: ✅ **FIX APPLIED**  
**Last Updated**: 2025-12-14T04:33:32+05:30
